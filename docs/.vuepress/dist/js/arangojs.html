<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Arangojs</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.5e739af7.css" as="style"><link rel="preload" href="/assets/js/app.2f8b41b1.js" as="script"><link rel="preload" href="/assets/js/2.4bed9571.js" as="script"><link rel="preload" href="/assets/js/31.33d8525c.js" as="script"><link rel="prefetch" href="/assets/js/10.c194749c.js"><link rel="prefetch" href="/assets/js/11.79dfd400.js"><link rel="prefetch" href="/assets/js/12.7d222d85.js"><link rel="prefetch" href="/assets/js/13.d5608af3.js"><link rel="prefetch" href="/assets/js/14.810bfc52.js"><link rel="prefetch" href="/assets/js/15.3f91be72.js"><link rel="prefetch" href="/assets/js/16.fe7fbc2b.js"><link rel="prefetch" href="/assets/js/17.66a76c97.js"><link rel="prefetch" href="/assets/js/18.28bf6059.js"><link rel="prefetch" href="/assets/js/19.2c4e0840.js"><link rel="prefetch" href="/assets/js/20.405ba4d0.js"><link rel="prefetch" href="/assets/js/21.48fb907e.js"><link rel="prefetch" href="/assets/js/22.0cce8fb3.js"><link rel="prefetch" href="/assets/js/23.69e24b57.js"><link rel="prefetch" href="/assets/js/24.f67805ae.js"><link rel="prefetch" href="/assets/js/25.7fa689b7.js"><link rel="prefetch" href="/assets/js/26.37f71112.js"><link rel="prefetch" href="/assets/js/27.e5104283.js"><link rel="prefetch" href="/assets/js/28.3991dd61.js"><link rel="prefetch" href="/assets/js/29.ccce9bb1.js"><link rel="prefetch" href="/assets/js/3.ef9b9872.js"><link rel="prefetch" href="/assets/js/30.f3c1306c.js"><link rel="prefetch" href="/assets/js/32.1aba491a.js"><link rel="prefetch" href="/assets/js/33.52481ee4.js"><link rel="prefetch" href="/assets/js/34.81e596fc.js"><link rel="prefetch" href="/assets/js/35.ac3c8c3f.js"><link rel="prefetch" href="/assets/js/36.b71b8245.js"><link rel="prefetch" href="/assets/js/37.d9b139ba.js"><link rel="prefetch" href="/assets/js/38.2c1468e7.js"><link rel="prefetch" href="/assets/js/39.b3aafb65.js"><link rel="prefetch" href="/assets/js/4.7eb02300.js"><link rel="prefetch" href="/assets/js/40.3aacfb2f.js"><link rel="prefetch" href="/assets/js/5.6e192604.js"><link rel="prefetch" href="/assets/js/6.0900e7ae.js"><link rel="prefetch" href="/assets/js/7.2dbfb217.js"><link rel="prefetch" href="/assets/js/8.bd61da2d.js"><link rel="prefetch" href="/assets/js/9.bfa302de.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5e739af7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="arangojs"><a href="#arangojs" aria-hidden="true" class="header-anchor">#</a> Arangojs</h1> <p><em>Reading through the sourcecode. This is only half the story. Open the arangojs repo alongside this chunk of writing and read through them together. Assuming they haven't fallen out of sync.</em></p> <hr> <h2 id="const-db-new-arangojs-database-configurationoptions"><a href="#const-db-new-arangojs-database-configurationoptions" aria-hidden="true" class="header-anchor">#</a> <code>const DB = new arangojs.Database(configurationOptions)</code></h2> <p>The first thing you do with this is to call <code>new arangojs.Database(configurationOptions)</code>.</p> <p><strong>index.js</strong> (this is <code>arangojs</code>)</p> <div class="language- extra-class"><pre class="language-text"><code>import Database from './database'
import aqlQuery from './aql-query'

module.exports = (...args) =&gt; new Database(...args)
module.exports.Database = Database //this is the line that's of interest. So we follow it into ./database
module.exports.aqlQuery =
module.exports.aql = aqlQuery
</code></pre></div><p><strong>database.js</strong></p> <p>These are the lines from database.js that get called (I've removed other stuff that doesn't run initially:</p> <div class="language- extra-class"><pre class="language-text"><code>import Connection from './connection'

export default class Database {
  constructor (config) {
    this._connection = new Connection(config) //again we jump into a new file
</code></pre></div><p><strong>connection.js</strong></p> <div class="language- extra-class"><pre class="language-text"><code>export default class Connection {
  constructor (config) {
    //Now some interesting stuff starts to happen! 
</code></pre></div><p>Defaults defined in here are merged with the config. All the work in the <code>constructor</code> function is to set up the values attached to this instance of the class. This is what it ends up looking like:</p> <div class="language- extra-class"><pre class="language-text"><code>ConnectionValues = {
    config: {
        url: 'http://localhost:8529',
        databaseName: '_system',
        arangoVersion: 30000,
        retryConnection: false,
        agentOptions: {
            maxSockets: 3,
            keepAlive: true,
            keepAliveMsecs: 1000
        },
        headers: {
            'x-arango-version': 30000 //set to match arangoVersion
            'authorization': `Basic ${btoa(auth)}` //auth is extracted from the parsed url passed in
        },
        promise: //passed to ./utils/promisify - for now looks like an override for a promise library,
        agent: //will be created in createRequest
    }
    arangoMajor: 3, //floor arangoVersion / 10000,
    _baseUrl: //the parsed url string that was passed in 
    _request: //a function defined in request.node.js
    _databasePath: '/_db/_system', //_system by default, set by config.databaseName
    promisify: 
    retryOptions: {
        forever: this.config.retryConnection,
        retries: 0,
        minTimeout: 5000,
        randomize: true
    }
}
</code></pre></div><p><strong>./util/request.js as createRequest</strong></p> <div class="language- extra-class"><pre class="language-text"><code>module.exports = require('./request.node') //into ./request.node.js we go!
</code></pre></div><p><strong>./request.node.js</strong></p> <div class="language- extra-class"><pre class="language-text"><code>export default function (baseUrl, agentOptions, agent) {
</code></pre></div><p>Recall that back in the Connection class constructor there was this:</p> <div class="language- extra-class"><pre class="language-text"><code>const {request, auth, url} = createRequest( //this is the function exported by request.node.js
    this.config.url,
    this.config.agentOptions,
    this.config.agent
)
</code></pre></div><p><code>this.config.url</code> passing in as <code>baseUrl</code> is passed through <a href="https://www.npmjs.com/package/url" target="_blank" rel="noopener noreferrer">url<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to split it into the relevant parts (eg host / port / path / query / etc).</p> <p><code>this.config.agent</code> is null unless you explicetly set one in the <code>new arangojs</code> function right at the start. If null a <code>new Agent</code> with <code>(this.config.agentOptions)</code> is created. (<a href="https://nodejs.org/api/http.html#http_class_http_agent" target="_blank" rel="noopener noreferrer">Agent<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> being a native node http connectoin manager).</p> <p><code>queue</code> is craeated, a <code>new LinkedList()</code>, <a href="https://www.npmjs.com/package/linkedlist" target="_blank" rel="noopener noreferrer">LinkedList<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> being something like an array with a few more functions.</p> <p><code>maxTasks</code> is set to double the <code>agent.maxSockets</code> or infinity!</p> <p><code>activeTasks</code> is set to 0.</p> <p><code>drainQueue()</code> is defined - this is only called at the end of <code>request()</code> which is defined next.</p> <div class="language- extra-class"><pre class="language-text"><code>return {
    request, //a function defined in here
    auth, //the username / password extracted from the passed in `this.config.url`
    url: baseUrlParts //the parsed `this.config.url`
}
</code></pre></div><p><strong>database.js</strong></p> <p>We have now concluded the creation of the connection class, the first line in the Database class constructor. Now we move onto the second.</p> <div class="language- extra-class"><pre class="language-text"><code>export default class Database {
  constructor (config) {
    this._connection = new Connection(config)
    this._api = this._connection.route('/_api') //back into the connection class we go!
</code></pre></div><p><strong>connection.js</strong></p> <p>This time we're here for the <code>route</code> function.</p> <div class="language- extra-class"><pre class="language-text"><code>import Route from './route' //off to ./route we go

route (path, headers) {
    //path is './_api'
    //headers is undefined
    //this is the connection class we've just gone through creating
    return new Route(this, path, headers)
}
</code></pre></div><p><strong>route.js</strong></p> <div class="language- extra-class"><pre class="language-text"><code>export default class Route {
    //connection is the connection class we're created
    //path is './_api'
    //headers is undefined
  constructor (connection, path, headers) {
    //each of these are just applied as this._&lt;key&gt;
</code></pre></div><p>During this instantiation nothing much happened in there. The DB now has a ._api with all the functions in that route class available to it. We'll get to those eventually no doubt.</p> <p><strong>database.js</strong></p> <p>The final line in the constructor. Just applying a variable as the db name.</p> <div class="language- extra-class"><pre class="language-text"><code>export default class Database {
  constructor (config) {
    this._connection = new Connection(config)
    this._api = this._connection.route('/_api')
    this.name = this._connection.config.databaseName
  }
</code></pre></div><p><strong>Summary of <code>new arangojs.Database(configurationOptions)</code></strong></p> <p>Nothing is actually run. No http requests have happened. No db calls have been made. We just have an object that is ready to be used.</p> <hr> <h2 id="db-createdatabase-mydb"><a href="#db-createdatabase-mydb" aria-hidden="true" class="header-anchor">#</a> <code>DB.createDatabase('mydb');</code></h2> <p>Assuming you're starting from scratch and your code cannot guarentee that a db has been set up this is probably the next function you're going to run.</p> <div class="language- extra-class"><pre class="language-text"><code>export default class Database {
    createDatabase (databaseName, users, cb) {
        //the cb is promisified. This just seems to be for legacy
</code></pre></div><p>There's a little prepping of the parameters then everything is passed to <code>this._api.post</code> which is a reference to <code>this._connection.route('/_api').post</code> so we follow that into the connection class again!</p> <p><strong>connection.js</strong></p> <p>looking for <code>route('/_api').post</code> we find the <code>return new Route(this, path, headers)</code> thing again (it has already been instantiated). So following into './route.js'</p> <p><strong>route.js</strong></p> <p>Here we find <code>post (path, body, qs, headers, callback) {</code>! So to get the context set up again:</p> <ol><li><p>Database constructor ran <code>this._api = this._connection.route('/_api')</code> which created a new Route class referenced by <code>DB._api</code>. The route class constructor just set _connection as the Connection class and _path as the path.</p></li> <li><p><code>DB.createDatabase('mydb');</code> ran:</p></li></ol> <div class="language- extra-class"><pre class="language-text"><code>this._api.post(
    '/database',
    {users, name: databaseName},
    (err, res) =&gt; err ? callback(err) : callback(null, res.body)
)
</code></pre></div><p>So now inside the Route class, the <code>post</code> function configures a kind of settings object then returns <code>_connection.request</code> with those settings passed into it. Now we have to look to the Connection class's request key again.</p> <p><strong>connection.js</strong></p> <p>The <code>request</code> function does a bunch more option configuring, sets up some request headers. Builds a url out of the options. Grabs the request object that was created during instantiation of the connection class which is fired and the results are dealt with. So we need to di into that request function.</p> <p><strong>request.node.js</strong></p> <p>Takes all the options. Makes an http request using the node http or https module. Looks like data is returned in chunks which is pushes into a <code>data</code> array. When that finishes: <code>res.body = Buffer.concat(data)</code> then fires the callback with res which will trigger the promosified bit earlier to resolve.</p> <p>This feels a little over complicated. It does appear that the goal of all this is to create a correctly formatted http request.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2f8b41b1.js" defer></script><script src="/assets/js/2.4bed9571.js" defer></script><script src="/assets/js/31.33d8525c.js" defer></script>
  </body>
</html>
